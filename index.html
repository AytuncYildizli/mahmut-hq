<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mahmut Global HQ ‚Äî Agent Office v5 LIVE</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;background:#0a0a1a;font-family:'Courier New',monospace;color:#e0e0e0;overflow:hidden}
#wrap{position:relative;width:100%;height:100%;display:flex;flex-direction:column}
#banner{height:56px;background:linear-gradient(180deg,#0d0d28,#0d0d20);border-bottom:2px solid #7b2ff2;display:flex;align-items:center;justify-content:space-between;padding:0 18px;z-index:10;flex-shrink:0}
#banner .logo{display:flex;align-items:center;gap:12px}
#banner .logo .m-box{width:38px;height:38px;background:linear-gradient(135deg,#7b2ff2,#a855f7);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:22px;color:#fff;border:2px solid #c084fc;box-shadow:0 0 14px #7b2ff280;border-radius:4px}
#banner .title{font-size:18px;font-weight:900;color:#c084fc;text-shadow:0 0 8px #7b2ff2,0 0 20px #7b2ff280;letter-spacing:3px}
#banner .subtitle{font-size:9px;color:#8888aa;letter-spacing:2px;margin-top:-2px}
#banner .right{display:flex;align-items:center;gap:14px;font-size:12px}
#banner .status-dots{display:flex;gap:8px;align-items:center}
#banner .status-dots span{display:flex;align-items:center;gap:4px;font-size:10px;color:#8888aa}
.dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.dot.on{background:#22c55e;box-shadow:0 0 6px #22c55e}
.dot.warn{background:#f59e0b;box-shadow:0 0 6px #f59e0b}
.dot.off{background:#555}
#clock{font-size:14px;color:#a78bfa;font-weight:700;letter-spacing:1px}
#canvas-wrap{flex:1;position:relative;overflow-y:auto;overflow-x:hidden;scroll-behavior:smooth}
#canvas-wrap::-webkit-scrollbar{width:8px}
#canvas-wrap::-webkit-scrollbar-track{background:#0a0a1a}
#canvas-wrap::-webkit-scrollbar-thumb{background:#7b2ff240;border-radius:4px}
#canvas-wrap::-webkit-scrollbar-thumb:hover{background:#7b2ff280}
canvas{display:block;image-rendering:pixelated;image-rendering:crisp-edges}
#scanlines{position:fixed;top:56px;left:0;right:0;bottom:36px;pointer-events:none;z-index:5;opacity:0.03;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.3) 2px,rgba(0,0,0,0.3) 4px)}
#vignette{position:fixed;top:56px;left:0;right:0;bottom:36px;pointer-events:none;z-index:4;background:radial-gradient(ellipse at center,transparent 50%,rgba(0,0,0,0.5) 100%)}
#ticker{height:36px;background:#0d0d24;border-top:2px solid #3b82f6;display:flex;align-items:center;padding:0 18px;z-index:10;flex-shrink:0;overflow:hidden;position:relative}
#ticker-inner{display:flex;align-items:center;gap:18px;font-size:12px;color:#8888aa;white-space:nowrap;animation:tickerScroll 50s linear infinite}
@keyframes tickerScroll{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
#ticker .pulse-dot{width:8px;height:8px;border-radius:50%;background:#22c55e;animation:pulse 2s infinite;flex-shrink:0}
.nominal{color:#22c55e;font-weight:700}
.warning-text{color:#f59e0b;font-weight:700}
.sep{color:#333;margin:0 2px}
@keyframes pulse{0%,100%{box-shadow:0 0 4px #22c55e}50%{box-shadow:0 0 12px #22c55e,0 0 20px #22c55e80}}
#live-badge{display:flex;align-items:center;gap:6px;font-size:11px;color:#8888aa;padding:2px 8px;border:1px solid #333;border-radius:4px;background:rgba(0,0,0,0.3)}
#live-badge.connected{border-color:#22c55e40;color:#22c55e}
#live-badge.connecting{border-color:#f59e0b40;color:#f59e0b}
#live-badge.error{border-color:#ef444440;color:#ef4444}
#live-dot{width:6px;height:6px;border-radius:50%;background:#555}
#live-badge.connected #live-dot{background:#22c55e;box-shadow:0 0 6px #22c55e;animation:pulse 2s infinite}
#live-badge.connecting #live-dot{background:#f59e0b;animation:pulse 1s infinite}
#live-badge.error #live-dot{background:#ef4444}
#last-updated{font-size:10px;color:#666;letter-spacing:0.5px}
@media(max-width:900px){
  #banner .status-dots{display:none}
  #banner .title{font-size:14px;letter-spacing:2px}
  #banner .subtitle{display:none}
  #last-updated{display:none}
}
@media(max-width:600px){
  #banner{padding:0 10px;height:48px}
  #banner .logo .m-box{width:32px;height:32px;font-size:18px}
  #ticker{height:30px}
  #ticker-inner{font-size:11px}
}
</style>
</head>
<body>
<div id="wrap">
<div id="banner">
 <div class="logo">
  <div class="m-box">M</div>
  <div style="display:flex;flex-direction:column">
   <div class="title">MAHMUT GLOBAL HQ</div>
   <div class="subtitle">AGENT COMMAND CENTER v5</div>
  </div>
 </div>
 <div class="right">
  <div class="status-dots" id="status-dots">
   <span><i class="dot on" id="dot-gateway"></i> Gateway</span>
   <span><i class="dot on" id="dot-whatsapp"></i> WhatsApp</span>
   <span><i class="dot on" id="dot-slack"></i> Slack</span>
   <span><i class="dot on" id="dot-memory"></i> Memory</span>
   <span><i class="dot on" id="dot-crons"></i> Crons</span>
   <span><i class="dot warn" id="dot-telegram"></i> Telegram</span>
  </div>
  <div id="live-badge" class="connecting">
   <span id="live-dot"></span>
   <span id="live-text">LOADING...</span>
  </div>
  <div id="last-updated">‚Äî</div>
  <div id="clock">00:00:00</div>
 </div>
</div>
<div id="canvas-wrap"><canvas id="c"></canvas></div>
<div id="scanlines"></div>
<div id="vignette"></div>
<div id="ticker">
 <span class="pulse-dot"></span>
 <div id="ticker-inner">
  <span class="nominal">INITIALIZING...</span>
 </div>
</div>
</div>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAHMUT GLOBAL HQ ‚Äî Agent Office v5 ‚Äî 27 Agents, 9 Sections
// Meeting Room + Live Data + Visual Fixes
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ‚îÄ LIVE DATA STATE ‚îÄ‚îÄ‚îÄ
let liveData = null;
let liveLastFetch = 0;
const LIVE_POLL_INTERVAL = 30000;
const STATUS_URL = '/api/status.json';

// ‚îÄ‚îÄ‚îÄ DEPARTMENT DEFINITIONS ‚îÄ‚îÄ‚îÄ
// 9th section is the Meeting Room (Toplantƒ± Odasƒ±)
const DEPARTMENTS = [
  {name:'COMMAND CENTER', color:'#a855f7', glowColor:'#c084fc', agents:3},
  {name:'TOPLANTI ODASI', color:'#f97316', glowColor:'#fb923c', agents:0, isMeeting:true},
  {name:'ENGINEERING', color:'#ef4444', glowColor:'#f87171', agents:3},
  {name:'KATMAN DIVISION', color:'#f59e0b', glowColor:'#fbbf24', agents:5},
  {name:'SEERS / CLAWDSPIRACY', color:'#8b5cf6', glowColor:'#a78bfa', agents:3},
  {name:'MEMORY & KNOWLEDGE', color:'#ec4899', glowColor:'#f472b6', agents:3},
  {name:'DEVOPS & INFRA', color:'#22c55e', glowColor:'#4ade80', agents:3},
  {name:'RESEARCH & INTEL', color:'#3b82f6', glowColor:'#60a5fa', agents:3},
  {name:'PERSONAL', color:'#14b8a6', glowColor:'#2dd4bf', agents:3}
];

// ‚îÄ‚îÄ‚îÄ AGENT DATA ‚îÄ‚îÄ‚îÄ
const AGENTS = [
  // COMMAND CENTER (dept 0)
  {name:'Mahmut',color:'#a855f7',role:'CEO / Orchestrator',status:'online',dept:0,col:1,scale:1.2,
   bubbles:['Ship it! üöÄ','All systems go','Sprint review time','Coordinating...']},
  {name:'Ziggy',color:'#f59e0b',role:'Creative & Comms',status:'online',dept:0,col:0,scale:1.0,
   bubbles:['Trending! üìà','Draft ready ‚úçÔ∏è','Going viral!','Content queued']},
  {name:'Scout',color:'#22c55e',role:'Research & Recon',status:'online',dept:0,col:2,scale:1.0,
   bubbles:['Signal found üîç','Scanning...','Intel acquired','Deep dive üèä']},

  // ENGINEERING (dept 2)
  {name:'Forge',color:'#ef4444',role:'Build & Deploy',status:'online',dept:2,col:0,scale:1.0,
   bubbles:['LGTM ‚úì','Building...üî®','PR merged','Tests pass ‚úÖ']},
  {name:'Dev',color:'#3b82f6',role:'Code & Debug',status:'online',dept:2,col:1,scale:1.0,
   bubbles:['Refactoring üîß','Bug squashed!','git push üì§','Clean code ‚ú®']},
  {name:'Codex',color:'#06b6d4',role:'AI Code Assist',status:'online',dept:2,col:2,scale:1.0,
   bubbles:['Neural compile','AI suggests...','Pattern found','Optimizing üß†']},

  // KATMAN DIVISION (dept 3)
  {name:'katman-seo',color:'#22c55e',role:'Search Optimization',status:'online',dept:3,col:0,scale:0.9,
   bubbles:['Ranking up! üìä','Keywords locked','SERP #1 üèÜ','Meta optimized']},
  {name:'katman-social',color:'#ec4899',role:'Social Media',status:'online',dept:3,col:1,scale:0.9,
   bubbles:['Post scheduled','Engagement ‚¨ÜÔ∏è','Story ready üì∏','Reel editing']},
  {name:'katman-orders',color:'#f97316',role:'Order Processing',status:'online',dept:3,col:2,scale:0.9,
   bubbles:['Order #847 üì¶','Shipping now','Confirmed ‚úì','Stock checked']},
  {name:'katman-analytics',color:'#3b82f6',role:'Data Analytics',status:'online',dept:3,col:3,scale:0.9,
   bubbles:['Crunching data','Report ready üìà','Funnel analyzed','CVR: 3.2% ‚Üë']},
  {name:'katman-product',color:'#14b8a6',role:'Product Manager',status:'idle',dept:3,col:4,scale:0.9,
   bubbles:['Roadmap update','Feature spec','Sprint planned','Backlog groomed']},

  // SEERS / CLAWDSPIRACY (dept 4)
  {name:'seers-writer',color:'#7c3aed',role:'Content Writer',status:'online',dept:4,col:0,scale:1.0,
   bubbles:['Writing...‚úçÔ∏è','Plot twist! üìñ','Draft v3 done','Muse strikes!']},
  {name:'seers-research',color:'#4f46e5',role:'Deep Research',status:'online',dept:4,col:1,scale:1.0,
   bubbles:['Source found üîé','Cross-ref done','Rabbit hole! üê∞','Evidence logged']},
  {name:'seers-editor',color:'#059669',role:'Editor',status:'online',dept:4,col:2,scale:1.0,
   bubbles:['Red pen ready','Proofread ‚úì','Style guide üìù','Published! üéâ']},

  // MEMORY & KNOWLEDGE (dept 5)
  {name:'memory-curator',color:'#ec4899',role:'Memory Manager',status:'online',dept:5,col:0,scale:1.0,
   bubbles:['Indexing... üß†','20K+ docs','Memory stored','Recall ready']},
  {name:'knowledge-graph',color:'#06b6d4',role:'Knowledge Graph',status:'online',dept:5,col:1,scale:1.0,
   bubbles:['Node linked üîó','Graph updated','3847 entities','Path found!']},
  {name:'archivist',color:'#d97706',role:'Archive Keeper',status:'idle',dept:5,col:2,scale:1.0,
   bubbles:['Filing away üìÅ','Archive sealed','History saved','Catalog done']},

  // DEVOPS & INFRA (dept 6)
  {name:'health-monitor',color:'#22c55e',role:'System Health',status:'online',dept:6,col:0,scale:1.0,
   bubbles:['All green ‚úÖ','Heartbeat OK','CPU: 12%','Latency: 23ms']},
  {name:'cron-manager',color:'#3b82f6',role:'Cron Scheduler',status:'online',dept:6,col:1,scale:1.0,
   bubbles:['21 jobs active','Next: 09:00','Cron fired ‚è∞','Schedule synced']},
  {name:'security-agent',color:'#dc2626',role:'Security',status:'online',dept:6,col:2,scale:1.0,
   bubbles:['Perimeter OK üõ°Ô∏è','Scan clean','Auth verified','No threats']},

  // RESEARCH & INTEL (dept 7)
  {name:'market-watch',color:'#22c55e',role:'Market Analysis',status:'online',dept:7,col:0,scale:1.0,
   bubbles:['Markets up üìà','Buy signal!','Volume spike','Trend spotted']},
  {name:'tech-scout',color:'#3b82f6',role:'Tech Radar',status:'idle',dept:7,col:1,scale:1.0,
   bubbles:['New framework!','Tech scanned','Innovation üí°','Benchmark done']},
  {name:'competitor-intel',color:'#6b21a8',role:'Competitor Intel',status:'online',dept:7,col:2,scale:1.0,
   bubbles:['Intel gathered','Stealth mode üïµÔ∏è','Report filed','Movement detected']},

  // PERSONAL (dept 8)
  {name:'calendar-agent',color:'#3b82f6',role:'Calendar',status:'online',dept:8,col:0,scale:1.0,
   bubbles:['Meeting @ 14:00','Free slot found','Reminder set ‚è∞','Week planned']},
  {name:'finance-agent',color:'#eab308',role:'Finance',status:'online',dept:8,col:1,scale:1.0,
   bubbles:['Budget OK üí∞','Invoice sent','‚Ç∫ tracked','Portfolio +2.3%']},
  {name:'denizevi-agent',color:'#14b8a6',role:'Smart Home',status:'online',dept:8,col:2,scale:1.0,
   bubbles:['Lights dimmed üè†','Temp: 22¬∞C','All secure üîí','Energy saved']}
];

// ‚îÄ‚îÄ‚îÄ COLOR UTILS ‚îÄ‚îÄ‚îÄ
function hexToRgb(h){
  if(h[0]!=='#')return{r:128,g:128,b:128};
  return{r:parseInt(h.slice(1,3),16),g:parseInt(h.slice(3,5),16),b:parseInt(h.slice(5,7),16)};
}
function rgba(hex,a){const c=hexToRgb(hex);return`rgba(${c.r},${c.g},${c.b},${a})`}
function darken(hex,f){const c=hexToRgb(hex);return`rgb(${c.r*f|0},${c.g*f|0},${c.b*f|0})`}
function lighten(hex,f){const c=hexToRgb(hex);return`rgb(${Math.min(255,c.r+(255-c.r)*f|0)},${Math.min(255,c.g+(255-c.g)*f|0)},${Math.min(255,c.b+(255-c.b)*f|0)})`}

// ‚îÄ‚îÄ‚îÄ CANVAS SETUP ‚îÄ‚îÄ‚îÄ
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
const wrap=document.getElementById('canvas-wrap');
let W,H,S;
const DEPT_HEIGHT = 360;
const HEADER_HEIGHT = 70;
const MEETING_ROOM_HEIGHT = 380;
const DEPT_GAP = 30;

function getDeptSectionHeight(deptIdx) {
  const dept = DEPARTMENTS[deptIdx];
  if (dept.isMeeting) return MEETING_ROOM_HEIGHT;
  return DEPT_HEIGHT;
}

function resize(){
  W=wrap.clientWidth;
  S=Math.max(0.5, Math.min(W/1600, 1.2));
  let totalH = 60*S;
  for(let i=0;i<DEPARTMENTS.length;i++){
    totalH += (getDeptSectionHeight(i)+HEADER_HEIGHT+DEPT_GAP)*S;
  }
  totalH += 100*S;
  H=Math.max(wrap.clientHeight, totalH);
  canvas.width=W;
  canvas.height=H;
  canvas.style.width=W+'px';
  canvas.style.height=H+'px';
}
resize();
window.addEventListener('resize',resize);

// ‚îÄ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ‚îÄ
function updateClock(){
  const now=new Date(new Date().toLocaleString('en-US',{timeZone:'Europe/Istanbul'}));
  const h=String(now.getHours()).padStart(2,'0');
  const m=String(now.getMinutes()).padStart(2,'0');
  const s=String(now.getSeconds()).padStart(2,'0');
  document.getElementById('clock').textContent=`${h}:${m}:${s}`;
}
setInterval(updateClock,1000);updateClock();

// ‚îÄ‚îÄ‚îÄ PIXEL HELPERS ‚îÄ‚îÄ‚îÄ
const PX=3;
function dp(bx,by,gx,gy,c,sc){
  const ps=PX*S*(sc||1);
  ctx.fillStyle=c;
  ctx.fillRect(bx+gx*ps,by+gy*ps,ps,ps);
}

// ‚îÄ‚îÄ‚îÄ PARTICLES ‚îÄ‚îÄ‚îÄ
let particles=[];
function spawnParticle(x,y,color){
  if(particles.length>300)return;
  particles.push({x,y,vx:(Math.random()-0.5)*0.4,vy:-0.5-Math.random()*0.6,life:1,color,size:1.5+Math.random()*2});
}
function updateParticles(dt){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx;p.y+=p.vy;p.life-=dt*0.012;
    if(p.life<=0)particles.splice(i,1);
  }
}
function drawParticles(){
  for(const p of particles){
    ctx.fillStyle=rgba(p.color,p.life*0.6);
    ctx.fillRect(p.x,p.y,p.size*S,p.size*S);
  }
}

// ‚îÄ‚îÄ‚îÄ STEAM ‚îÄ‚îÄ‚îÄ
let steamParts=[];
function spawnSteam(x,y){
  if(steamParts.length>100)return;
  steamParts.push({x:x+(Math.random()-0.5)*4*S,y,vy:-0.3-Math.random()*0.3,vx:(Math.random()-0.5)*0.2,life:1,size:2});
}
function updateSteam(dt){
  for(let i=steamParts.length-1;i>=0;i--){
    const p=steamParts[i];
    p.x+=p.vx;p.y+=p.vy;p.life-=dt*0.014;
    if(p.life<=0)steamParts.splice(i,1);
  }
}
function drawSteam(){
  for(const p of steamParts){
    ctx.fillStyle=rgba('#ffffff',p.life*0.3);
    ctx.fillRect(p.x,p.y,p.size*S,p.size*S);
  }
}

// ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ
function getDeptY(deptIdx){
  let y = 50*S;
  for(let i=0;i<deptIdx;i++){
    y += (getDeptSectionHeight(i)+HEADER_HEIGHT+DEPT_GAP)*S;
  }
  return y;
}

function getAgentPos(agent){
  const dy=getDeptY(agent.dept);
  const dept=DEPARTMENTS[agent.dept];
  const numCols=dept.agents;
  const margin=80*S;
  const areaW=W-margin*2;
  const colW=areaW/numCols;
  const cx=margin+agent.col*colW+colW/2;
  const cy=dy+HEADER_HEIGHT*S+160*S;
  return{x:cx,y:cy};
}

// ‚îÄ‚îÄ‚îÄ DRAW NEON SIGN ‚îÄ‚îÄ‚îÄ
function drawNeonSign(text, cx, y, color, glowColor, t){
  const fontSize=20*S;
  ctx.font=`900 ${fontSize}px 'Courier New', monospace`;
  ctx.textAlign='center';
  ctx.textBaseline='middle';

  const pulse=0.6+Math.sin(t*0.002)*0.2;

  // Backing plate
  const tw=ctx.measureText(text).width;
  const plateW=tw+40*S, plateH=fontSize+20*S;
  ctx.fillStyle=rgba('#0a0a1a',0.7);
  ctx.fillRect(cx-plateW/2, y-plateH/2, plateW, plateH);
  ctx.strokeStyle=rgba(color,0.4*pulse);
  ctx.lineWidth=2*S;
  ctx.strokeRect(cx-plateW/2, y-plateH/2, plateW, plateH);

  // Glow layers
  ctx.shadowColor=glowColor;
  ctx.shadowBlur=25*S*pulse;
  ctx.fillStyle=rgba(glowColor,0.15*pulse);
  ctx.fillText(text,cx,y);
  ctx.shadowBlur=12*S*pulse;
  ctx.fillStyle=rgba(color,0.6);
  ctx.fillText(text,cx,y);
  ctx.shadowBlur=5*S;
  ctx.fillStyle=color;
  ctx.fillText(text,cx,y);
  ctx.shadowBlur=0;

  // Underline
  ctx.fillStyle=rgba(color,0.35*pulse);
  ctx.fillRect(cx-tw/2-10*S, y+fontSize/2+6*S, tw+20*S, 2*S);
}

// ‚îÄ‚îÄ‚îÄ DRAW DEPARTMENT SECTION ‚îÄ‚îÄ‚îÄ
function drawDeptSection(deptIdx, t){
  const dept=DEPARTMENTS[deptIdx];
  const dy=getDeptY(deptIdx);
  const sectionH=(getDeptSectionHeight(deptIdx)+HEADER_HEIGHT)*S;

  // Ambient light
  const grad=ctx.createRadialGradient(W/2,dy+sectionH/2,0,W/2,dy+sectionH/2,W*0.6);
  grad.addColorStop(0,rgba(dept.color,0.04));
  grad.addColorStop(0.6,rgba(dept.color,0.01));
  grad.addColorStop(1,'transparent');
  ctx.fillStyle=grad;
  ctx.fillRect(0,dy,W,sectionH);

  // Floor tiles
  const floorY=dy+HEADER_HEIGHT*S+60*S;
  const tileSize=20*S;
  for(let y2=floorY;y2<dy+sectionH;y2+=tileSize){
    for(let x2=0;x2<W;x2+=tileSize){
      const isLight=((Math.floor(x2/tileSize)+Math.floor(y2/tileSize))%2===0);
      ctx.fillStyle=isLight?rgba('#1a1a3e',0.6):rgba('#141432',0.6);
      ctx.fillRect(x2,y2,tileSize,tileSize);
    }
  }

  // Separator line
  if(deptIdx>0){
    const sepY = dy - DEPT_GAP*S/2;
    ctx.fillStyle=rgba(dept.color,0.3);
    ctx.fillRect(40*S,sepY,W-80*S,1);
    ctx.fillStyle=rgba(dept.color,0.1);
    ctx.fillRect(40*S,sepY+1,W-80*S,1);
    // Corner accents
    ctx.fillStyle=rgba(dept.color,0.2);
    ctx.fillRect(40*S,sepY-3*S,20*S,3*S);
    ctx.fillRect(W-60*S,sepY-3*S,20*S,3*S);
  }

  // Neon sign
  drawNeonSign(dept.name, W/2, dy+35*S, dept.color, dept.glowColor, t);
}

// ‚îÄ‚îÄ‚îÄ MEETING ROOM RENDERING ‚îÄ‚îÄ‚îÄ
function drawMeetingRoom(t){
  const deptIdx = 1;
  const dy = getDeptY(deptIdx);
  const dept = DEPARTMENTS[deptIdx];
  const roomY = dy + HEADER_HEIGHT*S + 30*S;
  const roomCX = W/2;

  // Meeting room walls (back wall)
  const wallW = Math.min(W*0.75, 900*S);
  const wallH = 200*S;
  const wallX = roomCX - wallW/2;
  const wallY = roomY;

  // Back wall
  ctx.fillStyle=rgba('#1a1a3e',0.8);
  ctx.fillRect(wallX, wallY, wallW, wallH);
  ctx.strokeStyle=rgba(dept.color,0.3);
  ctx.lineWidth=2*S;
  ctx.strokeRect(wallX, wallY, wallW, wallH);

  // Glass wall effect (top)
  for(let i=0;i<5;i++){
    ctx.fillStyle=rgba(dept.color,0.03);
    ctx.fillRect(wallX+i*wallW/5, wallY, wallW/5-2*S, wallH);
  }

  // Whiteboard/Screen on back wall
  const screenW = 200*S;
  const screenH = 100*S;
  const screenX = roomCX - screenW/2;
  const screenY = wallY + 15*S;

  // Screen frame
  ctx.fillStyle='#222';
  ctx.fillRect(screenX-4*S, screenY-4*S, screenW+8*S, screenH+8*S);
  ctx.fillStyle='#0c1020';
  ctx.fillRect(screenX, screenY, screenW, screenH);

  // Screen content ‚Äî meeting topic
  const meetingData = liveData?.meeting;
  const topic = meetingData?.topic || 'Toplantƒ± Bekleniyor...';
  const isActive = meetingData?.active ?? true;

  if(isActive){
    // Active meeting ‚Äî show topic and pulsing border
    const screenPulse = 0.5 + Math.sin(t*0.003)*0.2;
    ctx.strokeStyle=rgba('#22c55e',screenPulse);
    ctx.lineWidth=2*S;
    ctx.strokeRect(screenX-1*S, screenY-1*S, screenW+2*S, screenH+2*S);

    // "LIVE" indicator
    ctx.fillStyle=rgba('#ef4444',0.8+Math.sin(t*0.005)*0.2);
    ctx.fillRect(screenX+5*S, screenY+5*S, 30*S, 12*S);
    ctx.fillStyle='#fff';
    ctx.font=`bold ${8*S}px 'Courier New', monospace`;
    ctx.textAlign='center';
    ctx.fillText('‚óè LIVE', screenX+20*S, screenY+13*S);

    // Topic text (wrapped)
    ctx.fillStyle=rgba('#c084fc',0.9);
    ctx.font=`bold ${10*S}px 'Courier New', monospace`;
    ctx.textAlign='center';
    const words = topic.split(' ');
    let line = '';
    let lineY = screenY + 35*S;
    const maxLineW = screenW - 20*S;
    for(const word of words){
      const test = line + (line?' ':'') + word;
      if(ctx.measureText(test).width > maxLineW && line){
        ctx.fillText(line, screenX+screenW/2, lineY);
        line = word;
        lineY += 14*S;
      } else {
        line = test;
      }
    }
    if(line) ctx.fillText(line, screenX+screenW/2, lineY);

    // Progress bar at bottom of screen
    const katmanReady = liveData?.katman?.readinessPercent || 85;
    ctx.fillStyle=rgba('#333',0.5);
    ctx.fillRect(screenX+10*S, screenY+screenH-18*S, screenW-20*S, 8*S);
    const barColor = katmanReady >= 80 ? '#22c55e' : (katmanReady >= 60 ? '#f59e0b' : '#ef4444');
    ctx.fillStyle=rgba(barColor,0.7);
    ctx.fillRect(screenX+10*S, screenY+screenH-18*S, (screenW-20*S)*(katmanReady/100), 8*S);
    ctx.fillStyle='#fff';
    ctx.font=`bold ${6*S}px 'Courier New', monospace`;
    ctx.fillText(`${katmanReady}% Launch Ready`, screenX+screenW/2, screenY+screenH-12*S);
  } else {
    // Idle screen ‚Äî screensaver
    ctx.fillStyle=rgba(dept.color,0.2);
    const bx = screenX+screenW/2+Math.sin(t*0.001)*screenW*0.3;
    const by = screenY+screenH/2+Math.cos(t*0.0013)*screenH*0.3;
    ctx.fillRect(bx-5*S,by-5*S,10*S,10*S);
    ctx.fillStyle=rgba('#fff',0.3);
    ctx.font=`${10*S}px 'Courier New', monospace`;
    ctx.textAlign='center';
    ctx.fillText('Toplantƒ± Bekleniyor...', screenX+screenW/2, screenY+screenH/2);
  }

  // Conference table (oval-ish pixel art)
  const tableW = 280*S;
  const tableH = 60*S;
  const tableX = roomCX - tableW/2;
  const tableY = wallY + wallH + 30*S;

  // Table shadow
  ctx.fillStyle=rgba('#000',0.2);
  ctx.fillRect(tableX+4*S, tableY+tableH+2*S, tableW, 6*S);

  // Table surface
  ctx.fillStyle='#3d2815';
  ctx.fillRect(tableX+10*S, tableY, tableW-20*S, tableH);
  ctx.fillRect(tableX, tableY+8*S, tableW, tableH-16*S);
  ctx.fillRect(tableX+4*S, tableY+4*S, tableW-8*S, tableH-8*S);

  // Table highlight
  ctx.fillStyle='#4a3320';
  ctx.fillRect(tableX+15*S, tableY+5*S, tableW-30*S, tableH-15*S);

  // Table edge
  ctx.fillStyle='#2a1a0e';
  ctx.fillRect(tableX, tableY+tableH-4*S, tableW, 4*S);

  // Table legs
  ctx.fillStyle='#1a0f05';
  ctx.fillRect(tableX+20*S, tableY+tableH, 6*S, 18*S);
  ctx.fillRect(tableX+tableW-26*S, tableY+tableH, 6*S, 18*S);

  // Chairs around table (top side)
  const participants = meetingData?.participants || ['Mahmut','Ziggy','katman-seo','katman-social'];
  const numChairs = Math.max(participants.length, 4);
  const chairColors = ['#a855f7','#f59e0b','#22c55e','#ec4899','#3b82f6','#ef4444'];

  for(let i=0;i<numChairs;i++){
    const chairX = tableX + 30*S + i*((tableW-60*S)/(numChairs-1||1));
    const isOccupied = i < participants.length;
    const chairColor = isOccupied ? (chairColors[i%chairColors.length]) : '#444';

    // Top chairs (above table)
    drawChair(chairX, tableY-20*S, chairColor, isOccupied, 'top', t);

    // Agent mini-sprite on chair (if occupied)
    if(isOccupied){
      drawMeetingAgent(chairX, tableY-45*S, chairColor, participants[i], t, i);
    }
  }

  // Bottom chairs
  for(let i=0;i<Math.min(numChairs-1,3);i++){
    const chairX = tableX + 60*S + i*((tableW-120*S)/2);
    drawChair(chairX, tableY+tableH+20*S, '#444', false, 'bottom', t);
  }

  // Participant name labels
  ctx.textAlign='center';
  for(let i=0;i<participants.length;i++){
    const chairX = tableX + 30*S + i*((tableW-60*S)/(numChairs-1||1));
    const name = participants[i];

    // Name background
    ctx.font=`bold ${11*S}px 'Courier New', monospace`;
    const nameW = ctx.measureText(name).width;
    ctx.fillStyle=rgba('#0a0a1a',0.8);
    ctx.fillRect(chairX-nameW/2-6*S, tableY-65*S, nameW+12*S, 16*S);
    ctx.strokeStyle=rgba(chairColors[i%chairColors.length],0.4);
    ctx.lineWidth=S;
    ctx.strokeRect(chairX-nameW/2-6*S, tableY-65*S, nameW+12*S, 16*S);

    ctx.fillStyle=chairColors[i%chairColors.length];
    ctx.fillText(name, chairX, tableY-55*S);
  }

  // Meeting duration
  if(meetingData?.startedAt){
    const startTime = new Date(meetingData.startedAt).getTime();
    const now = Date.now();
    const durMin = Math.floor((now - startTime)/60000);
    const durStr = durMin >= 60 ? `${Math.floor(durMin/60)}h ${durMin%60}m` : `${durMin}m`;

    ctx.fillStyle=rgba('#fff',0.4);
    ctx.font=`${9*S}px 'Courier New', monospace`;
    ctx.textAlign='center';
    ctx.fillText(`‚è± Duration: ${durStr}`, roomCX, tableY+tableH+50*S);
  }
}

function drawChair(x, y, color, occupied, side, t){
  const cw = 22*S, ch = 16*S;
  // Seat
  ctx.fillStyle=darken(color,0.5);
  ctx.fillRect(x-cw/2, y, cw, ch);
  ctx.fillStyle=occupied?color:rgba(color,0.3);
  ctx.fillRect(x-cw/2+2*S, y+2*S, cw-4*S, ch-4*S);
  // Back rest (only for top chairs)
  if(side==='top'){
    ctx.fillStyle=darken(color,0.6);
    ctx.fillRect(x-cw/2+2*S, y-10*S, cw-4*S, 12*S);
  }
}

function drawMeetingAgent(x, y, color, name, t, idx){
  // Mini pixel agent (simplified)
  const sc = 0.7;
  const ps = PX*S*sc;
  const bob = Math.sin(t*0.003+idx*1.5)*1.5*S;

  // Head
  ctx.fillStyle=color;
  ctx.fillRect(x-3*ps, y+bob, 6*ps, 5*ps);
  // Eyes
  ctx.fillStyle='#fff';
  ctx.fillRect(x-2*ps, y+1*ps+bob, ps, ps);
  ctx.fillRect(x+1*ps, y+1*ps+bob, ps, ps);
  ctx.fillStyle='#1a1a2e';
  ctx.fillRect(x-1.5*ps, y+1.5*ps+bob, ps*0.6, ps*0.6);
  ctx.fillRect(x+1.5*ps, y+1.5*ps+bob, ps*0.6, ps*0.6);
  // Body
  ctx.fillStyle=color;
  ctx.fillRect(x-4*ps, y+5*ps+bob, 8*ps, 6*ps);
  // Arms
  ctx.fillStyle=darken(color,0.7);
  ctx.fillRect(x-5*ps, y+5*ps+bob, ps, 4*ps);
  ctx.fillRect(x+4*ps, y+5*ps+bob, ps, 4*ps);

  // Speaking indicator (animated)
  if(Math.sin(t*0.005+idx*2)>0.5){
    ctx.fillStyle=rgba('#fff',0.3+Math.sin(t*0.01+idx)*0.2);
    ctx.fillRect(x+4*ps, y-2*ps+bob, 3*ps, 2*ps);
    ctx.fillRect(x+5*ps, y-4*ps+bob, 2*ps, 2*ps);
  }
}

// ‚îÄ‚îÄ‚îÄ DRAW DESK ‚îÄ‚îÄ‚îÄ
function drawDesk(cx,cy,scale,agent,t){
  const dw=80*S*scale, dh=22*S*scale;
  const dx=cx-dw/2, dy=cy+16*S*scale;
  ctx.fillStyle=rgba('#000',0.25);ctx.fillRect(dx+3*S,dy+dh,dw,4*S);
  ctx.fillStyle='#2a1a0e';ctx.fillRect(dx,dy,dw,dh);
  ctx.fillStyle='#3d2815';ctx.fillRect(dx+2*S,dy+2*S,dw-4*S,dh-5*S);
  ctx.fillStyle='#1a0f05';ctx.fillRect(dx,dy+dh-3*S,dw,3*S);
  ctx.fillStyle='#1a0f05';
  ctx.fillRect(dx+4*S,dy+dh,3*S,14*S*scale);
  ctx.fillRect(dx+dw-7*S,dy+dh,3*S,14*S*scale);
  drawMonitor(cx,dy-3*S*scale,scale,agent,t);
  if(agent.col%2===0){
    const mugX=cx+28*S*scale, mugY=dy+3*S;
    ctx.fillStyle='#f5f5dc';ctx.fillRect(mugX,mugY,5*S,7*S);
    ctx.fillStyle='#e0d5b0';ctx.fillRect(mugX+5*S,mugY+2*S,2*S,3*S);
    ctx.fillStyle='#4a3520';ctx.fillRect(mugX+1*S,mugY+1*S,3*S,2*S);
    if(agent.status==='online'&&Math.random()<0.05)spawnSteam(mugX+2*S,mugY-2*S);
  }
}

// ‚îÄ‚îÄ‚îÄ DRAW MONITOR ‚îÄ‚îÄ‚îÄ
function drawMonitor(cx,by,scale,agent,t){
  const mw=30*S*scale, mh=20*S*scale;
  const mx=cx-mw/2, my=by-mh;
  const isOff=agent.status==='offline';
  const isIdle=agent.status==='idle';
  ctx.fillStyle='#222';ctx.fillRect(mx-2*S,my-2*S,mw+4*S,mh+4*S);
  ctx.fillStyle=isOff?'#0a0a0a':(isIdle?'#080818':'#0c1020');
  ctx.fillRect(mx,my,mw,mh);
  ctx.fillStyle='#222';
  ctx.fillRect(cx-3*S,by,6*S,5*S*scale);
  ctx.fillRect(cx-6*S,by+4*S*scale,12*S,2*S);
  if(isOff)return;
  ctx.save();
  ctx.beginPath();ctx.rect(mx,my,mw,mh);ctx.clip();
  const pad=2*S, cw2=mw-pad*2, ch2=mh-pad*2;
  const sx=mx+pad, sy=my+pad;
  if(isIdle){
    const dx2=sx+Math.sin(t*0.001)*cw2*0.3+cw2/2;
    const dy2=sy+Math.cos(t*0.0013)*ch2*0.3+ch2/2;
    ctx.fillStyle=rgba(agent.color,0.2);
    ctx.fillRect(dx2-3*S,dy2-3*S,6*S,6*S);
    ctx.restore();return;
  }
  const role=agent.role.toLowerCase();
  if(role.includes('ceo')||role.includes('orchestrat')){
    for(let i=0;i<5;i++){ctx.fillStyle=rgba('#22c55e',0.5+i*0.05);ctx.fillRect(sx,sy+i*(ch2/5),cw2*(0.3+Math.sin(i*2.7+t*0.001)*0.3),2*S);}
    if(Math.sin(t*0.006)>0){ctx.fillStyle='#22c55e';ctx.fillRect(sx,sy+ch2-2*S,3*S,2*S);}
  } else if(role.includes('creative')||role.includes('social')){
    const colors=['#ef4444','#3b82f6','#f59e0b','#22c55e','#a855f7','#ec4899'];
    for(let i=0;i<3;i++)for(let j=0;j<3;j++){ctx.fillStyle=rgba(colors[(i*3+j)%6],0.4);ctx.fillRect(sx+j*(cw2/3)+S,sy+i*(ch2/3)+S,cw2/3-2*S,ch2/3-2*S);}
  } else if(role.includes('build')||role.includes('code')||role.includes('debug')){
    for(let i=0;i<6;i++){const indent=(i%3)*4*S;ctx.fillStyle=rgba(agent.color,0.4+Math.sin(i+t*0.002)*0.2);ctx.fillRect(sx+indent,sy+i*(ch2/6),cw2*(0.2+Math.random()*0.4),1.5*S);}
  } else if(role.includes('ai code')){
    for(let i=0;i<4;i++){const nx=sx+i*(cw2/3);const ny=sy+ch2/2+Math.sin(t*0.003+i)*ch2*0.25;ctx.fillStyle=rgba('#06b6d4',0.6);ctx.fillRect(nx,ny,3*S,3*S);if(i<3){ctx.fillStyle=rgba('#06b6d4',0.2);ctx.fillRect(nx,ny,cw2/3,S);}}
  } else if(role.includes('search')||role.includes('seo')){
    for(let i=0;i<4;i++){ctx.fillStyle=rgba('#22c55e',0.3);ctx.fillRect(sx,sy+i*(ch2/4),cw2*0.8,1.5*S);ctx.fillStyle=rgba('#3b82f6',0.4);ctx.fillRect(sx,sy+i*(ch2/4)+2*S,cw2*0.5,S);}
  } else if(role.includes('order')){
    ctx.fillStyle=rgba('#f97316',0.4);ctx.fillRect(sx+cw2*0.3,sy+ch2*0.2,cw2*0.4,ch2*0.3);ctx.fillStyle=rgba('#22c55e',0.6);const prog=(Math.sin(t*0.001)+1)/2;ctx.fillRect(sx,sy+ch2*0.7,cw2*prog,2*S);
  } else if(role.includes('analytic')||role.includes('data')){
    for(let i=0;i<5;i++){const bh2=ch2*(0.2+Math.sin(t*0.002+i)*0.3);ctx.fillStyle=rgba('#3b82f6',0.5);ctx.fillRect(sx+i*(cw2/5)+S,sy+ch2-bh2,cw2/5-2*S,bh2);}
  } else if(role.includes('product')){
    for(let i=0;i<3;i++){ctx.fillStyle=rgba('#14b8a6',0.2);ctx.fillRect(sx+i*(cw2/3)+S,sy,cw2/3-2*S,ch2);for(let j=0;j<2;j++){ctx.fillStyle=rgba('#14b8a6',0.4);ctx.fillRect(sx+i*(cw2/3)+2*S,sy+2*S+j*ch2*0.35,cw2/3-4*S,ch2*0.25);}}
  } else if(role.includes('writer')){
    for(let i=0;i<7;i++){ctx.fillStyle=rgba('#c4b5fd',0.3+Math.sin(i*0.8)*0.15);ctx.fillRect(sx+4*S,sy+i*(ch2/7),cw2*(0.5+Math.sin(i*3)*0.3)-4*S,S);}
  } else if(role.includes('deep research')||role.includes('recon')){
    ctx.fillStyle=rgba(agent.color,0.3);ctx.beginPath();ctx.arc(sx+cw2*0.4,sy+ch2*0.4,6*S,0,Math.PI*2);ctx.fill();for(let i=0;i<3;i++){ctx.fillStyle=rgba(agent.color,0.2);ctx.fillRect(sx,sy+ch2*0.6+i*3*S,cw2*0.7,S);}
  } else if(role.includes('editor')){
    for(let i=0;i<6;i++){ctx.fillStyle=rgba('#d1d5db',0.3);ctx.fillRect(sx,sy+i*(ch2/6),cw2*0.8,S);if(i%2===0){ctx.fillStyle=rgba('#ef4444',0.5);ctx.fillRect(sx+cw2*0.3,sy+i*(ch2/6)-S,cw2*0.2,3*S);}}
  } else if(role.includes('memory')){
    for(let i=0;i<5;i++){const nx=sx+Math.sin(t*0.002+i*1.5)*cw2*0.3+cw2*0.5;const ny=sy+Math.cos(t*0.002+i*1.5)*ch2*0.3+ch2*0.5;ctx.fillStyle=rgba('#ec4899',0.5);ctx.fillRect(nx-S,ny-S,3*S,3*S);}
  } else if(role.includes('knowledge')){
    for(let i=0;i<4;i++){const nx=sx+((i*cw2/3)%cw2);const ny=sy+(i%2)*ch2*0.5+ch2*0.2;ctx.fillStyle=rgba('#06b6d4',0.5);ctx.fillRect(nx,ny,3*S,3*S);if(i<3){ctx.fillStyle=rgba('#06b6d4',0.15);ctx.fillRect(nx,ny+S,cw2/3,S);}}
  } else if(role.includes('archive')){
    const bColors=['#ef4444','#f59e0b','#22c55e','#3b82f6','#a855f7'];
    for(let i=0;i<5;i++){ctx.fillStyle=rgba(bColors[i],0.4);ctx.fillRect(sx+S,sy+i*(ch2/5)+S,3*S,ch2/5-2*S);ctx.fillStyle=rgba('#d1d5db',0.2);ctx.fillRect(sx+5*S,sy+i*(ch2/5)+2*S,cw2*0.5,S);}
  } else if(role.includes('health')||role.includes('system')){
    ctx.strokeStyle=rgba('#22c55e',0.6);ctx.lineWidth=S;ctx.beginPath();for(let i=0;i<=10;i++){const px2=sx+i*(cw2/10);const py2=sy+ch2/2+(i===5?-ch2*0.3:(i===6?ch2*0.2:Math.sin(t*0.005+i)*ch2*0.05));i===0?ctx.moveTo(px2,py2):ctx.lineTo(px2,py2);}ctx.stroke();
  } else if(role.includes('cron')||role.includes('schedul')){
    const ccx=sx+cw2/2,ccy=sy+ch2/2,cr=Math.min(cw2,ch2)*0.35;ctx.strokeStyle=rgba('#3b82f6',0.4);ctx.lineWidth=S;ctx.beginPath();ctx.arc(ccx,ccy,cr,0,Math.PI*2);ctx.stroke();const ang=t*0.001;ctx.beginPath();ctx.moveTo(ccx,ccy);ctx.lineTo(ccx+Math.cos(ang)*cr*0.6,ccy+Math.sin(ang)*cr*0.6);ctx.stroke();ctx.beginPath();ctx.moveTo(ccx,ccy);ctx.lineTo(ccx+Math.cos(ang*3)*cr*0.4,ccy+Math.sin(ang*3)*cr*0.4);ctx.stroke();
  } else if(role.includes('security')){
    ctx.fillStyle=rgba('#dc2626',0.3);ctx.fillRect(sx+cw2*0.3,sy+ch2*0.15,cw2*0.4,ch2*0.5);ctx.fillStyle=rgba('#22c55e',0.5);ctx.fillRect(sx+cw2*0.42,sy+ch2*0.35,cw2*0.16,ch2*0.15);
  } else if(role.includes('market')){
    for(let i=0;i<6;i++){const bh2=ch2*(0.15+Math.sin(t*0.001+i*2)*0.2);const by2=sy+ch2/2-bh2/2;const isGreen=Math.sin(t*0.001+i)>0;ctx.fillStyle=rgba(isGreen?'#22c55e':'#ef4444',0.5);ctx.fillRect(sx+i*(cw2/6)+cw2/12-S,by2,3*S,bh2);ctx.fillRect(sx+i*(cw2/6)+cw2/12,by2-ch2*0.1,S,ch2*0.1+bh2+ch2*0.1);}
  } else if(role.includes('tech radar')||role.includes('satellite')){
    const ang2=t*0.003;const rcx=sx+cw2/2,rcy=sy+ch2/2;ctx.fillStyle=rgba('#3b82f6',0.15);ctx.beginPath();ctx.arc(rcx,rcy,Math.min(cw2,ch2)*0.4,0,Math.PI*2);ctx.fill();ctx.strokeStyle=rgba('#3b82f6',0.3);ctx.lineWidth=S;ctx.beginPath();ctx.moveTo(rcx,rcy);ctx.lineTo(rcx+Math.cos(ang2)*cw2*0.4,rcy+Math.sin(ang2)*ch2*0.4);ctx.stroke();
  } else if(role.includes('competitor')||role.includes('spy')){
    for(let i=0;i<4;i++){ctx.fillStyle=rgba('#6b21a8',0.2+Math.sin(t*0.003+i)*0.15);ctx.fillRect(sx,sy+i*(ch2/4)+S,cw2*(0.4+Math.sin(i*2+t*0.002)*0.3),S);}ctx.fillStyle=rgba('#ef4444',0.3);ctx.fillRect(sx+cw2*0.7,sy+2*S,3*S,3*S);
  } else if(role.includes('calendar')){
    for(let i=0;i<3;i++)for(let j=0;j<4;j++){ctx.fillStyle=rgba('#3b82f6',(i*4+j===Math.floor(t*0.001)%12)?0.6:0.15);ctx.fillRect(sx+j*(cw2/4)+S,sy+i*(ch2/3)+S,cw2/4-2*S,ch2/3-2*S);}
  } else if(role.includes('finance')){
    ctx.fillStyle=rgba('#eab308',0.4);for(let i=0;i<3;i++){ctx.fillRect(sx,sy+i*(ch2/3)+S,cw2*0.6,S*1.5);ctx.fillStyle=rgba(Math.sin(t*0.001+i)>0?'#22c55e':'#ef4444',0.5);ctx.fillRect(sx+cw2*0.65,sy+i*(ch2/3)+S,cw2*0.2,S*1.5);ctx.fillStyle=rgba('#eab308',0.4);}
  } else if(role.includes('smart home')||role.includes('house')){
    ctx.fillStyle=rgba('#14b8a6',0.2);ctx.fillRect(sx,sy,cw2,ch2);ctx.fillStyle=rgba('#14b8a6',0.4);ctx.fillRect(sx+S,sy+S,cw2*0.45,ch2*0.45);ctx.fillRect(sx+cw2*0.5,sy+S,cw2*0.45,ch2*0.45);ctx.fillRect(sx+S,sy+ch2*0.5,cw2*0.45,ch2*0.45);ctx.fillStyle=rgba('#22c55e',0.6);ctx.fillRect(sx+cw2*0.55,sy+ch2*0.6,cw2*0.3,2*S);
  }
  ctx.restore();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SPRITE DEFINITIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function drawSpriteFromDef(bx,by,sc,rows){
  const ps=PX*S*(sc||1);
  for(const [gy,segs] of rows){
    for(const [gx,gw,c] of segs){
      ctx.fillStyle=c;
      ctx.fillRect(bx+gx*ps,by+gy*ps,gw*ps,ps);
    }
  }
}

// ‚îÄ‚îÄ‚îÄ SPRITE: Mahmut ‚îÄ‚îÄ‚îÄ
function drawMahmut(bx,by,sc,t){
  const col='#a855f7',colD=darken('#a855f7',0.7),colL=lighten('#a855f7',0.3);
  const gold='#fbbf24',goldD='#d4960a',skin='#e8d5b7';
  const glow=0.7+Math.sin(t*0.005)*0.3;
  const glowGold=rgba('#fbbf24',glow),glowW=rgba('#ffffff',glow);
  drawSpriteFromDef(bx,by,sc,[
    [0,[[6,1,gold],[8,1,gold],[10,1,gold],[12,1,gold],[14,1,gold]]],
    [1,[[5,1,goldD],[6,1,gold],[7,1,'#ef4444'],[8,1,gold],[9,1,goldD],[10,1,'#3b82f6'],[11,1,gold],[12,1,goldD],[13,1,'#22c55e'],[14,1,gold],[15,1,goldD]]],
    [2,[[5,11,gold]]],[3,[[5,11,col]]],
    [4,[[4,1,col],[5,11,col],[16,1,col]]],
    [5,[[4,1,col],[5,2,'#fff'],[7,1,'#1a1a2e'],[9,3,col],[12,2,'#fff'],[14,1,'#1a1a2e'],[16,1,col]]],
    [6,[[4,1,col],[5,1,'#fff'],[6,2,'#1a1a2e'],[9,3,col],[12,1,'#fff'],[13,2,'#1a1a2e'],[16,1,col]]],
    [7,[[5,1,col],[6,1,col],[7,1,col],[8,1,colD],[9,1,colD],[10,1,colD],[11,1,col],[12,1,col],[13,1,col],[14,1,col]]],
    [8,[[5,11,col]]],
    [9,[[2,3,colL],[5,11,col],[16,3,colL]]],
    [10,[[2,1,goldD],[3,2,col],[5,11,col],[16,2,col],[18,1,goldD]]],
    [11,[[3,2,col],[5,11,col],[16,2,col]]],
    [12,[[3,2,col],[5,4,col],[9,1,glowGold],[10,1,glowGold],[11,1,glowGold],[12,4,col],[16,2,col]]],
    [13,[[3,2,col],[5,4,col],[9,1,glowGold],[10,1,glowW],[11,1,glowGold],[12,4,col],[16,2,col]]],
    [14,[[3,2,col],[5,4,col],[9,1,glowGold],[10,1,glowGold],[11,1,glowGold],[12,4,col],[16,2,col]]],
    [15,[[3,2,col],[5,11,col],[16,2,col]]],
    [16,[[3,1,col],[4,1,skin],[5,11,col],[16,1,skin],[17,1,col]]],
    [17,[[5,11,goldD],[10,1,gold]]],
    [18,[[6,3,colD],[12,3,colD]]],[19,[[6,3,colD],[12,3,colD]]],[20,[[6,3,colD],[12,3,colD]]],[21,[[6,3,colD],[12,3,colD]]],
    [22,[[5,4,'#1a1a2e'],[11,4,'#1a1a2e']]]
  ]);
}

function drawZiggy(bx,by,sc,t){
  const col='#f59e0b',colD=darken('#f59e0b',0.7),colL=lighten('#f59e0b',0.4);
  drawSpriteFromDef(bx,by,sc,[
    [0,[[6,1,colL],[9,1,colL],[13,1,colL]]],
    [1,[[5,1,col],[7,1,colL],[8,1,col],[10,1,colL],[12,1,col],[14,1,colL]]],
    [2,[[4,1,col],[6,1,colL],[9,1,col],[11,1,colL],[13,1,col],[15,1,col]]],
    [3,[[5,10,col]]],[4,[[4,1,col],[5,10,col],[15,1,col]]],
    [5,[[4,1,col],[5,3,'#fff'],[8,4,col],[12,3,'#fff'],[15,1,col]]],
    [6,[[4,1,col],[5,1,'#fff'],[6,2,'#1a1a2e'],[8,4,col],[12,1,'#1a1a2e'],[13,1,'#1a1a2e'],[14,1,'#fff'],[15,1,col]]],
    [7,[[5,1,col],[6,1,col],[7,1,'#d97706'],[8,1,'#d97706'],[9,1,'#d97706'],[10,1,'#d97706'],[11,1,col],[12,1,col],[13,1,col]]],
    [8,[[5,10,col]]],
    [9,[[4,2,'#ef4444'],[6,8,col],[14,2,'#ef4444']]],
    [10,[[3,1,'#dc2626'],[4,1,'#ef4444'],[5,1,col],[6,8,col],[14,1,col],[15,1,'#ef4444'],[16,1,'#dc2626']]],
    [11,[[3,1,'#ef4444'],[6,8,col]]],[12,[[3,1,'#dc2626'],[6,8,col]]],
    [13,[[6,3,col],[9,1,colL],[10,1,colL],[11,5,col]]],
    [14,[[5,1,col],[6,3,col],[9,1,colL],[10,1,'#fff'],[11,1,colL],[12,4,col],[15,1,col]]],
    [15,[[5,1,col],[6,3,col],[9,1,colL],[10,1,colL],[11,5,col],[15,1,col]]],
    [16,[[5,1,'#fcd34d'],[6,8,col],[14,1,col],[15,1,'#fcd34d']]],
    [17,[[6,8,col]]],
    [18,[[7,2,colD],[11,2,colD]]],[19,[[7,2,colD],[11,2,colD]]],[20,[[7,2,colD],[11,2,colD]]],
    [21,[[6,3,'#1a1a2e'],[11,3,'#1a1a2e']]]
  ]);
}

function drawScout(bx,by,sc,t){
  const col='#22c55e',colD=darken('#22c55e',0.6),colL=lighten('#22c55e',0.4);
  const metal='#9ca3af';const eyeOff=Math.floor((Math.sin(t*0.004)+1)*2);
  drawSpriteFromDef(bx,by,sc,[
    [0,[[9,3,metal]]],[1,[[10,1,'#6b7280']]],[2,[[10,1,'#6b7280']]],
    [3,[[7,7,col]]],[4,[[6,1,col],[7,7,col],[14,1,col]]],
    [5,[[6,1,col],[7+eyeOff,1,'#fff'],[7+eyeOff+1,1,'#00ff88'],[7,7,col],[14,1,col]]],
    [6,[[6,1,col],[7+eyeOff,1,'#00ff88'],[7+eyeOff+1,1,'#fff'],[7,7,col],[14,1,col]]],
    [7,[[7,7,col]]],[8,[[6,8,col]]],
    [9,[[5,1,col],[6,1,colL],[7,1,colL],[8,6,col],[14,1,col]]],
    [10,[[5,1,col],[6,2,col],[8,1,colL],[9,1,colL],[10,4,col],[14,1,col]]],
    [11,[[5,1,col],[6,3,col],[9,1,colL],[10,1,colL],[11,1,colL],[12,2,col],[14,1,col]]],
    [12,[[5,1,col],[6,2,col],[8,1,col],[9,1,col],[10,1,col],[11,1,colL],[12,1,colL],[13,1,colL],[14,1,col]]],
    [13,[[5,1,col],[6,2,col],[8,6,col],[14,1,col]]],
    [14,[[5,1,col],[6,1,colL],[7,1,colL],[8,1,colL],[9,1,col],[10,4,col],[14,1,col]]],
    [15,[[5,1,colL],[6,8,col],[14,1,colL]]],[16,[[6,8,col]]],
    [17,[[8,2,colD],[11,2,colD]]],[18,[[8,2,colD],[11,2,colD]]],[19,[[8,2,colD],[11,2,colD]]],[20,[[8,2,colD],[11,2,colD]]],
    [21,[[7,3,'#1a1a2e'],[11,3,'#1a1a2e']]]
  ]);
}

function drawForge(bx,by,sc,t){
  const col='#ef4444',colD=darken('#ef4444',0.6),colL=lighten('#ef4444',0.3);
  const metal='#6b7280',metalL='#9ca3af';const vG=0.6+Math.sin(t*0.008)*0.4;
  drawSpriteFromDef(bx,by,sc,[
    [1,[[4,12,metal]]],[2,[[4,12,metal]]],
    [3,[[4,1,metal],[5,10,rgba('#ff0000',vG)],[15,1,metal]]],
    [4,[[4,1,metalL],[5,10,rgba('#ff6666',vG*0.6)],[15,1,metalL]]],
    [5,[[3,14,col]]],[6,[[3,14,col]]],[7,[[3,14,col]]],
    [8,[[4,1,colD],[5,10,col],[15,1,colD]]],[9,[[3,14,col]]],
    [10,[[2,2,col],[4,12,metal],[16,2,col]]],
    [11,[[2,2,col],[4,1,metalL],[5,10,col],[15,1,metalL],[16,2,col]]],
    [12,[[2,2,col],[4,1,col],[5,3,col],[8,1,colL],[9,1,colL],[10,1,col],[11,1,colL],[12,3,col],[15,1,col],[16,2,col]]],
    [13,[[2,2,col],[4,1,col],[5,4,col],[9,2,metalL],[11,4,col],[15,1,col],[16,2,col]]],
    [14,[[2,2,col],[4,12,col],[16,2,col]]],[15,[[2,2,col],[4,12,col],[16,2,col]]],[16,[[2,2,col],[4,12,col],[16,2,col]]],
    [17,[[1,1,metalL],[2,1,metalL],[3,1,metalL],[4,12,col],[16,1,metalL],[17,1,metalL],[18,1,metalL]]],
    [18,[[4,12,colD]]],[19,[[5,4,colD],[11,4,colD]]],[20,[[5,4,colD],[11,4,colD]]],[21,[[5,4,colD],[11,4,colD]]],
    [22,[[4,5,metal],[11,5,metal]]]
  ]);
}

function drawDev(bx,by,sc,t){
  const col='#3b82f6',colD=darken('#3b82f6',0.6),colL=lighten('#3b82f6',0.3);
  drawSpriteFromDef(bx,by,sc,[
    [1,[[4,1,'#444'],[15,1,'#444']]],
    [2,[[4,1,'#555'],[5,10,col],[15,1,'#555']]],[3,[[4,1,'#666'],[5,10,col],[15,1,'#666']]],[4,[[4,1,'#555'],[5,10,col],[15,1,'#555']]],
    [5,[[5,2,'#fff'],[7,1,'#1a1a2e'],[8,4,col],[12,2,'#fff'],[14,1,'#1a1a2e']]],
    [6,[[5,1,'#fff'],[6,2,'#1a1a2e'],[8,4,col],[12,1,'#1a1a2e'],[13,1,'#1a1a2e'],[14,1,'#fff']]],
    [7,[[5,2,col],[7,1,col],[8,1,colD],[9,1,colD],[10,1,colD],[11,1,col],[12,2,col]]],
    [8,[[5,10,col]]],
    [9,[[4,1,colD],[5,2,colD],[7,6,col],[13,2,colD],[15,1,colD]]],
    [10,[[4,1,colD],[5,2,colD],[7,6,col],[13,2,colD],[15,1,colD]]],
    [11,[[4,2,col],[6,8,col],[14,2,col]]],
    [12,[[4,2,col],[6,2,col],[8,1,'#22c55e'],[9,2,'#22c55e'],[10,1,'#22c55e'],[11,1,col],[12,1,col],[13,1,col],[14,2,col]]],
    [13,[[4,2,col],[6,2,col],[8,1,col],[9,1,'#22c55e'],[10,1,col],[11,1,col],[12,1,col],[13,1,col],[14,2,col]]],
    [14,[[4,2,col],[6,8,col],[14,2,col]]],[15,[[4,2,col],[6,8,col],[14,2,col]]],
    [16,[[4,1,'#e8d5b7'],[5,1,col],[6,8,col],[13,1,col],[14,1,'#e8d5b7']]],
    [17,[[6,8,col]]],
    [18,[[7,2,colD],[11,2,colD]]],[19,[[7,2,colD],[11,2,colD]]],[20,[[7,2,colD],[11,2,colD]]],
    [21,[[6,3,'#1a1a2e'],[11,3,'#1a1a2e']]]
  ]);
}

function drawCodex(bx,by,sc,t){
  const col='#06b6d4',colD=darken('#06b6d4',0.6),colL=lighten('#06b6d4',0.4);const pulse=0.5+Math.sin(t*0.004)*0.3;
  drawSpriteFromDef(bx,by,sc,[
    [2,[[6,8,col]]],[3,[[5,1,col],[6,8,col],[14,1,col]]],[4,[[5,1,col],[6,8,col],[14,1,col]]],
    [5,[[5,1,col],[6,2,'#fff'],[8,1,'#0e7490'],[9,2,col],[11,2,'#fff'],[13,1,'#0e7490'],[14,1,col]]],
    [6,[[5,1,col],[6,1,col],[7,2,'#0e7490'],[9,2,col],[11,1,col],[12,2,'#0e7490'],[14,1,col]]],
    [7,[[6,2,col],[8,1,colD],[9,1,colD],[10,1,colD],[11,2,col]]],
    [8,[[6,8,col]]],[9,[[5,1,col],[6,8,col],[13,1,col]]],[10,[[4,2,col],[6,8,col],[14,2,col]]],
    [11,[[4,2,col],[6,1,col],[7,1,rgba('#00ffff',pulse)],[8,2,col],[10,1,rgba('#00ffff',pulse)],[11,1,col],[12,2,col],[14,2,col]]],
    [12,[[4,2,col],[6,2,col],[8,1,rgba('#00ffff',pulse)],[9,1,col],[10,1,col],[11,1,rgba('#00ffff',pulse)],[12,2,col],[14,2,col]]],
    [13,[[4,2,col],[6,1,col],[7,1,rgba('#00ffff',pulse)],[8,1,col],[9,2,rgba('#00ffff',pulse)],[11,1,col],[12,1,rgba('#00ffff',pulse)],[13,1,col],[14,2,col]]],
    [14,[[4,2,col],[6,8,col],[14,2,col]]],[15,[[4,2,col],[6,8,col],[14,2,col]]],
    [16,[[4,1,'#e8d5b7'],[5,1,col],[6,8,col],[13,1,col],[14,1,'#e8d5b7']]],
    [17,[[6,8,col]]],
    [18,[[7,2,colD],[11,2,colD]]],[19,[[7,2,colD],[11,2,colD]]],[20,[[7,2,colD],[11,2,colD]]],
    [21,[[6,3,'#1a1a2e'],[11,3,'#1a1a2e']]]
  ]);
  const ps=PX*S*(sc||1);const syms=['<','>','{','}','Œª','‚àë'];
  ctx.fillStyle=rgba('#06b6d4',0.3+Math.sin(t*0.003)*0.15);ctx.font=`${8*S}px monospace`;
  ctx.fillText(syms[Math.floor(t*0.001)%syms.length],bx-4*ps+Math.sin(t*0.002)*8*S,by+4*ps+Math.cos(t*0.003)*5*S);
}

// ‚îÄ‚îÄ‚îÄ Generic agent sprite (used for agents without custom sprites) ‚îÄ‚îÄ‚îÄ
function drawGenericAgent(bx,by,sc,t,color,accents){
  const col=color,colD=darken(color,0.6),colL=lighten(color,0.4);
  drawSpriteFromDef(bx,by,sc,[
    [2,[[7,6,col]]],[3,[[6,1,col],[7,6,col],[13,1,col]]],[4,[[6,8,col]]],
    [5,[[6,2,'#fff'],[8,1,darken(color,0.4)],[9,2,col],[11,2,'#fff'],[13,1,darken(color,0.4)]]],
    [6,[[6,1,'#fff'],[7,2,darken(color,0.4)],[9,2,col],[11,1,darken(color,0.4)],[12,1,darken(color,0.4)],[13,1,'#fff']]],
    [7,[[7,2,col],[9,1,colD],[10,1,colD],[11,2,col]]],
    [8,[[6,8,col]]],[9,[[5,10,col]]],[10,[[5,1,col],[6,8,col],[13,1,col]]],
    [11,[[5,1,col],[6,8,col],[13,1,col]]],[12,[[5,1,col],[6,8,col],[13,1,col]]],
    [13,[[5,1,col],[6,8,col],[13,1,col]]],[14,[[5,1,col],[6,8,col],[13,1,col]]],
    [15,[[5,1,'#e8d5b7'],[6,8,col],[13,1,'#e8d5b7']]],[16,[[6,8,col]]],
    [17,[[7,2,colD],[11,2,colD]]],[18,[[7,2,colD],[11,2,colD]]],[19,[[7,2,colD],[11,2,colD]]],
    [20,[[6,3,'#1a1a2e'],[11,3,'#1a1a2e']]]
  ]);
}

function drawKatmanSeo(bx,by,sc,t){ drawGenericAgent(bx,by,sc,t,'#22c55e');
  const ps=PX*S*(sc||1);ctx.strokeStyle=rgba('#fff',0.4);ctx.lineWidth=S;
  ctx.beginPath();ctx.arc(bx+16*ps,by+1*ps,3*ps,0,Math.PI*2);ctx.stroke();
  ctx.beginPath();ctx.moveTo(bx+18*ps,by+3*ps);ctx.lineTo(bx+20*ps,by+5*ps);ctx.stroke();
}
function drawKatmanSocial(bx,by,sc,t){ drawGenericAgent(bx,by,sc,t,'#ec4899'); }
function drawKatmanOrders(bx,by,sc,t){ drawGenericAgent(bx,by,sc,t,'#f97316'); }
function drawKatmanAnalytics(bx,by,sc,t){ drawGenericAgent(bx,by,sc,t,'#3b82f6'); }
function drawKatmanProduct(bx,by,sc,t){ drawGenericAgent(bx,by,sc,t,'#14b8a6'); }

function drawSeersWriter(bx,by,sc,t){
  const col='#7c3aed',colD=darken('#7c3aed',0.6),colL=lighten('#7c3aed',0.4);
  drawSpriteFromDef(bx,by,sc,[
    [1,[[7,6,colD]]],[2,[[6,1,colD],[7,6,col],[13,1,colD]]],
    [3,[[6,8,col]]],[4,[[6,8,col]]],
    [5,[[6,2,'#fff'],[8,1,'#4c1d95'],[9,2,col],[11,2,'#fff'],[13,1,'#4c1d95']]],
    [6,[[6,1,'#fff'],[7,2,'#4c1d95'],[9,2,col],[11,1,'#4c1d95'],[12,1,'#4c1d95'],[13,1,'#fff']]],
    [7,[[7,2,col],[9,1,colD],[10,1,colD],[11,2,col]]],[8,[[6,8,col]]],
    [9,[[4,12,colD]]],[10,[[4,1,colD],[5,10,col],[14,1,colD]]],
    [11,[[4,1,colD],[5,10,col],[14,1,colD]]],[12,[[4,1,colD],[5,10,col],[14,1,colD]]],
    [13,[[4,1,colD],[5,10,col],[14,1,colD]]],[14,[[4,1,colD],[5,10,col],[14,1,colD]]],
    [15,[[4,1,colD],[5,10,col],[14,1,colD]]],
    [16,[[4,1,'#e8d5b7'],[5,10,col],[14,1,'#e8d5b7']]],
    [17,[[5,10,colD]]],
    [18,[[6,3,colD],[11,3,colD]]],[19,[[6,3,colD],[11,3,colD]]],
    [20,[[5,4,'#1a1a2e'],[11,4,'#1a1a2e']]]
  ]);
  const ps=PX*S*(sc||1);
  ctx.fillStyle='#fbbf24';ctx.fillRect(bx+16*ps,by+1*ps,ps,6*ps);
  ctx.fillStyle='#fff';ctx.fillRect(bx+15*ps,by+0*ps,3*ps,2*ps);
}

function drawSeersResearch(bx,by,sc,t){
  const col='#4f46e5',colD=darken('#4f46e5',0.6);
  drawSpriteFromDef(bx,by,sc,[
    [0,[[7,6,'#3730a3']]],[1,[[5,10,'#312e81']]],
    [2,[[6,8,col]]],[3,[[6,1,col],[7,6,col],[13,1,col]]],[4,[[6,8,col]]],
    [5,[[6,2,'#fff'],[8,1,'#312e81'],[9,2,col],[11,2,'#fff'],[13,1,'#312e81']]],
    [6,[[6,1,'#fff'],[7,2,'#312e81'],[9,2,col],[11,1,'#312e81'],[12,1,'#312e81'],[13,1,'#fff']]],
    [7,[[7,2,col],[9,1,colD],[10,1,colD],[11,2,col]]],[8,[[6,8,col]]],
    [9,[[5,10,col]]],[10,[[5,1,col],[6,8,col],[13,1,col]]],
    [11,[[5,1,col],[6,8,col],[13,1,col]]],[12,[[5,1,col],[6,8,col],[13,1,col]]],
    [13,[[5,1,col],[6,8,col],[13,1,col]]],[14,[[5,1,col],[6,8,col],[13,1,col]]],
    [15,[[5,1,'#e8d5b7'],[6,8,col],[13,1,'#e8d5b7']]],[16,[[6,8,col]]],
    [17,[[7,2,colD],[11,2,colD]]],[18,[[7,2,colD],[11,2,colD]]],[19,[[7,2,colD],[11,2,colD]]],
    [20,[[6,3,'#1a1a2e'],[11,3,'#1a1a2e']]]
  ]);
  const ps=PX*S*(sc||1);
  ctx.strokeStyle=rgba('#fbbf24',0.5);ctx.lineWidth=S;
  ctx.beginPath();ctx.arc(bx+17*ps,by+13*ps,2.5*ps,0,Math.PI*2);ctx.stroke();
  ctx.beginPath();ctx.moveTo(bx+19*ps,by+15*ps);ctx.lineTo(bx+21*ps,by+17*ps);ctx.stroke();
}

function drawSeersEditor(bx,by,sc,t){ drawGenericAgent(bx,by,sc,t,'#059669');
  const ps=PX*S*(sc||1);ctx.fillStyle='#ef4444';ctx.fillRect(bx+15*ps,by+1*ps,ps,5*ps);ctx.fillStyle='#fbbf24';ctx.fillRect(bx+15*ps,by+6*ps,ps,ps);
}

function drawMemoryCurator(bx,by,sc,t){
  const col='#ec4899',colD=darken('#ec4899',0.6),colL=lighten('#ec4899',0.4);const pulse=0.5+Math.sin(t*0.003)*0.3;
  drawSpriteFromDef(bx,by,sc,[
    [1,[[7,2,colL],[11,2,colL]]],[2,[[6,1,col],[7,6,col],[13,1,col]]],[3,[[6,8,col]]],
    [4,[[6,2,col],[8,1,col],[9,1,rgba('#fff',pulse)],[10,1,col],[11,2,col],[13,1,col]]],
    [5,[[6,2,'#fff'],[8,1,'#9d174d'],[9,2,col],[11,2,'#fff'],[13,1,'#9d174d']]],
    [6,[[6,1,'#fff'],[7,2,'#9d174d'],[9,2,col],[11,1,'#9d174d'],[12,1,'#9d174d'],[13,1,'#fff']]],
    [7,[[7,2,col],[9,1,colD],[10,1,colD],[11,2,col]]],[8,[[6,8,col]]],
    [9,[[5,10,col]]],[10,[[5,1,col],[6,8,col],[13,1,col]]],
    [11,[[5,1,col],[6,1,col],[7,1,rgba('#fff',0.4)],[8,2,col],[10,1,rgba('#fff',0.4)],[11,2,col],[13,1,col]]],
    [12,[[5,1,col],[6,2,col],[8,1,rgba('#fff',0.4)],[9,1,col],[10,1,col],[11,1,rgba('#fff',0.4)],[12,1,col],[13,1,col]]],
    [13,[[5,1,col],[6,1,col],[7,1,col],[8,1,rgba('#fff',0.4)],[9,2,col],[11,1,rgba('#fff',0.4)],[12,1,col],[13,1,col]]],
    [14,[[5,1,col],[6,8,col],[13,1,col]]],
    [15,[[5,1,'#e8d5b7'],[6,8,col],[13,1,'#e8d5b7']]],[16,[[6,8,col]]],
    [17,[[7,2,colD],[11,2,colD]]],[18,[[7,2,colD],[11,2,colD]]],[19,[[7,2,colD],[11,2,colD]]],
    [20,[[6,3,'#1a1a2e'],[11,3,'#1a1a2e']]]
  ]);
}

function drawKnowledgeGraph(bx,by,sc,t){ drawGenericAgent(bx,by,sc,t,'#06b6d4'); }
function drawArchivist(bx,by,sc,t){ drawGenericAgent(bx,by,sc,t,'#d97706'); }
function drawHealthMonitor(bx,by,sc,t){ drawGenericAgent(bx,by,sc,t,'#22c55e'); }

function drawCronManager(bx,by,sc,t){
  const col='#3b82f6',colD=darken('#3b82f6',0.6);
  drawSpriteFromDef(bx,by,sc,[
    [1,[[8,1,'#6b7280'],[11,1,'#6b7280']]],
    [2,[[7,6,col]]],[3,[[6,1,col],[7,6,col],[13,1,col]]],[4,[[6,8,col]]],
    [5,[[6,2,'#fff'],[8,1,'#1e40af'],[9,2,col],[11,2,'#fff'],[13,1,'#1e40af']]],
    [6,[[6,1,'#fff'],[7,2,'#1e40af'],[9,2,col],[11,1,'#1e40af'],[12,1,'#1e40af'],[13,1,'#fff']]],
    [7,[[7,2,col],[9,1,colD],[10,1,colD],[11,2,col]]],[8,[[6,8,col]]],
    [9,[[5,10,col]]],[10,[[5,1,col],[6,8,col],[13,1,col]]],
    [11,[[5,1,col],[6,1,col],[7,1,'#1e3a5f'],[8,3,'#1e3a5f'],[11,1,'#1e3a5f'],[12,1,col],[13,1,col]]],
    [12,[[5,1,col],[6,1,col],[7,1,'#1e3a5f'],[8,1,'#1e3a5f'],[9,1,'#fff'],[10,1,'#fff'],[11,1,'#1e3a5f'],[12,1,col],[13,1,col]]],
    [13,[[5,1,col],[6,1,col],[7,1,'#1e3a5f'],[8,3,'#1e3a5f'],[11,1,'#1e3a5f'],[12,1,col],[13,1,col]]],
    [14,[[5,1,col],[6,8,col],[13,1,col]]],
    [15,[[5,1,'#e8d5b7'],[6,8,col],[13,1,'#e8d5b7']]],[16,[[6,8,col]]],
    [17,[[7,2,colD],[11,2,colD]]],[18,[[7,2,colD],[11,2,colD]]],[19,[[7,2,colD],[11,2,colD]]],
    [20,[[6,3,'#1a1a2e'],[11,3,'#1a1a2e']]]
  ]);
  const ps=PX*S*(sc||1);const ccx=bx+9.5*ps,ccy=by+12*ps;
  ctx.strokeStyle=rgba('#fff',0.6);ctx.lineWidth=S*0.8;const ang=t*0.002;
  ctx.beginPath();ctx.moveTo(ccx,ccy);ctx.lineTo(ccx+Math.cos(ang)*2*ps,ccy+Math.sin(ang)*2*ps);ctx.stroke();
}

function drawSecurityAgent(bx,by,sc,t){ drawGenericAgent(bx,by,sc,t,'#dc2626'); }
function drawMarketWatch(bx,by,sc,t){ drawGenericAgent(bx,by,sc,t,'#22c55e'); }

function drawTechScout(bx,by,sc,t){
  const col='#3b82f6',colD=darken('#3b82f6',0.6);const metal='#9ca3af';
  drawSpriteFromDef(bx,by,sc,[
    [0,[[7,3,metal],[12,1,'#ef4444']]],[1,[[8,1,metal],[10,1,metal]]],
    [2,[[7,6,col]]],[3,[[6,1,col],[7,6,col],[13,1,col]]],[4,[[6,8,col]]],
    [5,[[6,2,'#fff'],[8,1,'#1e40af'],[9,2,col],[11,2,'#fff'],[13,1,'#1e40af']]],
    [6,[[6,1,'#fff'],[7,2,'#1e40af'],[9,2,col],[11,1,'#1e40af'],[12,1,'#1e40af'],[13,1,'#fff']]],
    [7,[[7,2,col],[9,1,colD],[10,1,colD],[11,2,col]]],[8,[[6,8,col]]],
    [9,[[5,10,col]]],[10,[[5,1,col],[6,8,col],[13,1,col]]],
    [11,[[5,1,col],[6,1,col],[7,1,rgba('#60a5fa',0.6)],[8,2,col],[10,1,rgba('#60a5fa',0.6)],[11,2,col],[13,1,col]]],
    [12,[[5,1,col],[6,2,col],[8,1,rgba('#60a5fa',0.4)],[9,1,col],[10,1,rgba('#60a5fa',0.4)],[11,2,col],[13,1,col]]],
    [13,[[5,1,col],[6,8,col],[13,1,col]]],[14,[[5,1,col],[6,8,col],[13,1,col]]],
    [15,[[5,1,'#e8d5b7'],[6,8,col],[13,1,'#e8d5b7']]],[16,[[6,8,col]]],
    [17,[[7,2,colD],[11,2,colD]]],[18,[[7,2,colD],[11,2,colD]]],[19,[[7,2,colD],[11,2,colD]]],
    [20,[[6,3,'#1a1a2e'],[11,3,'#1a1a2e']]]
  ]);
  const ps=PX*S*(sc||1);const wave=Math.sin(t*0.005)*0.4+0.4;
  ctx.strokeStyle=rgba('#60a5fa',wave*0.3);ctx.lineWidth=S*0.5;
  ctx.beginPath();ctx.arc(bx+9*ps,by+0*ps,3*ps+Math.sin(t*0.003)*2*ps,0,Math.PI*2);ctx.stroke();
}

function drawCompetitorIntel(bx,by,sc,t){
  const col='#6b21a8',colD=darken('#6b21a8',0.6);
  drawSpriteFromDef(bx,by,sc,[
    [0,[[7,6,colD]]],[1,[[5,10,'#3b0764']]],
    [2,[[6,8,col]]],[3,[[6,1,col],[7,6,col],[13,1,col]]],[4,[[6,8,col]]],
    [5,[[6,1,'#1a1a2e'],[7,1,'#1a1a2e'],[8,1,'#1a1a2e'],[9,1,col],[10,1,col],[11,1,'#1a1a2e'],[12,1,'#1a1a2e'],[13,1,'#1a1a2e']]],
    [6,[[6,1,'#1a1a2e'],[7,1,'#333'],[8,1,'#1a1a2e'],[9,2,col],[11,1,'#1a1a2e'],[12,1,'#333'],[13,1,'#1a1a2e']]],
    [7,[[7,2,col],[9,1,colD],[10,1,colD],[11,2,col]]],[8,[[6,8,col]]],
    [9,[[5,10,col]]],[10,[[5,1,col],[6,8,col],[13,1,col]]],
    [11,[[5,1,col],[6,8,col],[13,1,col]]],[12,[[5,1,col],[6,8,col],[13,1,col]]],
    [13,[[5,1,col],[6,8,col],[13,1,col]]],[14,[[5,1,col],[6,8,col],[13,1,col]]],
    [15,[[5,1,'#e8d5b7'],[6,8,col],[13,1,'#e8d5b7']]],[16,[[6,8,col]]],
    [17,[[7,2,colD],[11,2,colD]]],[18,[[7,2,colD],[11,2,colD]]],[19,[[7,2,colD],[11,2,colD]]],
    [20,[[6,3,'#1a1a2e'],[11,3,'#1a1a2e']]]
  ]);
}

function drawCalendarAgent(bx,by,sc,t){ drawGenericAgent(bx,by,sc,t,'#3b82f6'); }
function drawFinanceAgent(bx,by,sc,t){ drawGenericAgent(bx,by,sc,t,'#eab308'); }
function drawDenizeviAgent(bx,by,sc,t){ drawGenericAgent(bx,by,sc,t,'#14b8a6'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SPRITE DRAWER MAP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const spriteDrawers = [
  drawMahmut, drawZiggy, drawScout,
  drawForge, drawDev, drawCodex,
  drawKatmanSeo, drawKatmanSocial, drawKatmanOrders,
  drawKatmanAnalytics, drawKatmanProduct,
  drawSeersWriter, drawSeersResearch, drawSeersEditor,
  drawMemoryCurator, drawKnowledgeGraph, drawArchivist,
  drawHealthMonitor, drawCronManager, drawSecurityAgent,
  drawMarketWatch, drawTechScout, drawCompetitorIntel,
  drawCalendarAgent, drawFinanceAgent, drawDenizeviAgent
];

// ‚îÄ‚îÄ‚îÄ DECORATIONS ‚îÄ‚îÄ‚îÄ
function drawPlant(x,y,sway,t){
  const sw=Math.sin(t*0.002+sway)*S;
  ctx.fillStyle='#8b4513';ctx.fillRect(x-5*S,y,10*S,8*S);
  ctx.fillStyle='#a0522d';ctx.fillRect(x-7*S,y-2*S,14*S,3*S);
  ctx.fillStyle='#166534';
  ctx.fillRect(x-3*S+sw,y-10*S,2*S,10*S);
  ctx.fillRect(x-8*S+sw,y-14*S,6*S,4*S);
  ctx.fillRect(x+2*S+sw,y-16*S,6*S,4*S);
  ctx.fillStyle='#22c55e';
  ctx.fillRect(x-6*S+sw,y-13*S,4*S,2*S);
  ctx.fillRect(x+3*S+sw,y-15*S,4*S,2*S);
  ctx.fillRect(x-1*S+sw,y-18*S,3*S,5*S);
}

function drawBookshelf(x,y){
  ctx.fillStyle='#5c3a1e';ctx.fillRect(x,y,35*S,50*S);
  ctx.fillStyle='#6b4226';ctx.fillRect(x+2*S,y+2*S,31*S,46*S);
  const bookColors=['#ef4444','#3b82f6','#22c55e','#f59e0b','#a855f7','#ec4899','#14b8a6'];
  for(let i=0;i<3;i++){
    const sy=y+3*S+i*15*S;
    ctx.fillStyle='#5c3a1e';ctx.fillRect(x+2*S,sy+11*S,31*S,2*S);
    let bx2=x+3*S;
    for(let j=0;j<5;j++){
      const bw=2*S+Math.random()*3*S;const bh=8*S+Math.random()*3*S;
      ctx.fillStyle=bookColors[(i*5+j)%7];ctx.fillRect(bx2,sy+11*S-bh,bw,bh);bx2+=bw+S;if(bx2>x+30*S)break;
    }
  }
}

function drawWhiteboard(x,y){
  ctx.fillStyle='#9ca3af';ctx.fillRect(x,y,50*S,35*S);
  ctx.fillStyle='#f5f5f5';ctx.fillRect(x+2*S,y+2*S,46*S,31*S);
  ctx.fillStyle='#a855f7';ctx.fillRect(x+20*S,y+5*S,10*S,4*S);
  ctx.fillStyle=rgba('#a855f7',0.5);ctx.fillRect(x+24*S,y+9*S,2*S,4*S);
  ctx.fillRect(x+10*S,y+13*S,28*S,S);
  const cols2=['#f59e0b','#ef4444','#22c55e','#3b82f6','#ec4899','#14b8a6','#6b21a8'];
  for(let i=0;i<7;i++){ctx.fillStyle=cols2[i];ctx.fillRect(x+4*S+i*6*S,y+14*S,5*S,3*S);ctx.fillStyle=rgba(cols2[i],0.4);ctx.fillRect(x+6*S+i*6*S,y+13*S,S,S);}
}

function drawWaterCooler(x,y){
  ctx.fillStyle=rgba('#60a5fa',0.4);ctx.fillRect(x-3*S,y-25*S,6*S,15*S);
  ctx.fillStyle=rgba('#93c5fd',0.3);ctx.fillRect(x-2*S,y-27*S,4*S,3*S);
  ctx.fillStyle='#d1d5db';ctx.fillRect(x-5*S,y-10*S,10*S,10*S);
  ctx.fillStyle='#9ca3af';ctx.fillRect(x-5*S,y-12*S,10*S,3*S);
  ctx.fillStyle='#ef4444';ctx.fillRect(x+4*S,y-8*S,2*S,2*S);
  ctx.fillStyle='#3b82f6';ctx.fillRect(x+4*S,y-5*S,2*S,2*S);
  ctx.fillStyle='#6b7280';ctx.fillRect(x-5*S,y,2*S,6*S);ctx.fillRect(x+3*S,y,2*S,6*S);
}

// ‚îÄ‚îÄ‚îÄ SPEECH BUBBLE ‚îÄ‚îÄ‚îÄ
function drawSpeechBubble(x,y,text,color){
  if(!text)return;
  const fontSize=10*S;
  ctx.font=`${fontSize}px 'Courier New', monospace`;
  const charW=ctx.measureText('M').width;
  const padding=6*S;
  const bw=Math.max(ctx.measureText(text).width+padding*2, 50*S);
  const bh=fontSize+padding*2;
  const bx=x-bw/2;
  const by2=y-bh-12*S;

  ctx.fillStyle=rgba(color,0.12);
  ctx.fillRect(bx+3*S,by2,bw-6*S,bh);
  ctx.fillRect(bx+2*S,by2+2*S,bw-4*S,bh-4*S);
  ctx.fillRect(bx,by2+3*S,bw,bh-6*S);

  ctx.fillStyle=rgba(color,0.5);
  ctx.fillRect(bx+3*S,by2,bw-6*S,S);ctx.fillRect(bx+3*S,by2+bh-S,bw-6*S,S);
  ctx.fillRect(bx,by2+3*S,S,bh-6*S);ctx.fillRect(bx+bw-S,by2+3*S,S,bh-6*S);
  ctx.fillRect(bx+S,by2+S,2*S,2*S);ctx.fillRect(bx+bw-3*S,by2+S,2*S,2*S);
  ctx.fillRect(bx+S,by2+bh-3*S,2*S,2*S);ctx.fillRect(bx+bw-3*S,by2+bh-3*S,2*S,2*S);

  ctx.fillStyle=rgba(color,0.12);
  ctx.fillRect(x-2*S,by2+bh,4*S,2*S);ctx.fillRect(x-S,by2+bh+2*S,2*S,2*S);
  ctx.fillStyle=rgba(color,0.5);
  ctx.fillRect(x-3*S,by2+bh,S,2*S);ctx.fillRect(x+2*S,by2+bh,S,2*S);
  ctx.fillRect(x-2*S,by2+bh+2*S,S,S);ctx.fillRect(x+S,by2+bh+2*S,S,S);

  ctx.fillStyle=rgba(color,0.9);
  ctx.font=`${fontSize}px 'Courier New', monospace`;
  ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText(text,bx+bw/2,by2+bh/2);
}

// ‚îÄ‚îÄ‚îÄ NAME TAG (IMPROVED ‚Äî larger, contrast bg, bigger status dot) ‚îÄ‚îÄ‚îÄ
function drawNameTag(x,y,name,role,color,status){
  const nameFontSize=12*S;
  const roleFontSize=8*S;

  // Name text
  ctx.font=`bold ${nameFontSize}px 'Courier New', monospace`;
  ctx.textAlign='center';ctx.textBaseline='top';
  const nameW=ctx.measureText(name).width;

  // Background plate for readability
  const plateW=nameW+28*S;
  const plateH=nameFontSize+roleFontSize+12*S;
  ctx.fillStyle=rgba('#0a0a1a',0.85);
  ctx.fillRect(x-plateW/2,y-3*S,plateW,plateH);
  ctx.strokeStyle=rgba(color,0.25);
  ctx.lineWidth=S;
  ctx.strokeRect(x-plateW/2,y-3*S,plateW,plateH);

  // Status dot (bigger, 4px radius)
  const dotR=4*S;
  const dotX=x-nameW/2-10*S;
  const dotY=y+nameFontSize/2;
  ctx.beginPath();ctx.arc(dotX,dotY,dotR,0,Math.PI*2);
  const dotColor=status==='online'?'#22c55e':(status==='idle'?'#f59e0b':'#555');
  ctx.fillStyle=dotColor;ctx.fill();
  if(status==='online'){
    ctx.strokeStyle=rgba('#22c55e',0.3);ctx.lineWidth=2*S;ctx.stroke();
  }

  // Name
  const isOff=status==='offline';
  ctx.fillStyle=isOff?rgba('#888',0.5):rgba(color,0.95);
  ctx.font=`bold ${nameFontSize}px 'Courier New', monospace`;
  ctx.fillText(name,x,y);

  // Role subtitle
  ctx.fillStyle=rgba('#888',0.6);
  ctx.font=`${roleFontSize}px 'Courier New', monospace`;
  ctx.fillText(role,x,y+nameFontSize+2*S);
}

// ‚îÄ‚îÄ‚îÄ BUBBLE CYCLE ‚îÄ‚îÄ‚îÄ
function getCurrentBubble(agent,t){
  if(!agent.bubbles||!agent.bubbles.length||agent.status!=='online')return null;
  const idx=Math.floor(t/8000)%agent.bubbles.length;
  const phase=(t%8000)/8000;
  if(phase>0.625)return null;
  return agent.bubbles[idx];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAIN RENDER LOOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lastTime=0;

function render(t){
  const dt=Math.min(t-lastTime,50);lastTime=t;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#0a0a1a';ctx.fillRect(0,0,W,H);

  // Draw department sections
  for(let d=0;d<DEPARTMENTS.length;d++){
    drawDeptSection(d,t);
  }

  // Draw meeting room (dept index 1)
  drawMeetingRoom(t);

  // Decorations
  for(let d=0;d<DEPARTMENTS.length;d++){
    if(DEPARTMENTS[d].isMeeting) continue;
    const dy=getDeptY(d);
    const baseY=dy+HEADER_HEIGHT*S+220*S;
    if(d%2===0){drawPlant(35*S,baseY,d,t);drawPlant(W-35*S,baseY,d+2,t);}
    if(d===0)drawWaterCooler(W-55*S,baseY-20*S);
    if(d===3)drawWaterCooler(35*S+20*S,baseY-20*S);
    if(d===4)drawBookshelf(12*S,dy+HEADER_HEIGHT*S+50*S);
    if(d===5)drawBookshelf(W-50*S,dy+HEADER_HEIGHT*S+50*S);
    if(d===0){
      const mPos=getAgentPos(AGENTS[0]);
      drawWhiteboard(mPos.x-25*S,dy+HEADER_HEIGHT*S+25*S);
    }
  }

  // Draw all agents
  AGENTS.forEach((agent,idx)=>{
    if(DEPARTMENTS[agent.dept].isMeeting) return;
    const pos=getAgentPos(agent);
    const isOnline=agent.status==='online';
    const isOff=agent.status==='offline';
    const isIdle=agent.status==='idle';
    const bob=isOnline?Math.sin(t*0.003+idx*1.2)*2.5*S:0;
    const asc=agent.scale;
    const spriteH=23*PX*S*asc;
    const spriteW=20*PX*S*asc;
    const ax=pos.x-spriteW/2;
    const ay=pos.y-spriteH+bob;

    drawDesk(pos.x,pos.y-6*S,asc,agent,t);

    if(isOff){ctx.globalAlpha=0.3;}else if(isIdle){ctx.globalAlpha=0.55;}
    if(spriteDrawers[idx]){spriteDrawers[idx](ax,ay,asc,t);}
    ctx.globalAlpha=1;

    if(isOnline && Math.random()<0.025){
      spawnParticle(pos.x+(Math.random()-0.5)*30*S,pos.y-15*S+Math.random()*15*S,agent.color);
    }

    // Name tag (improved)
    drawNameTag(pos.x,pos.y+36*S*asc,agent.name,agent.role,agent.color,agent.status);

    const bubble=getCurrentBubble(agent,t+idx*2000);
    if(bubble){drawSpeechBubble(pos.x,ay-8*S,bubble,agent.color);}
  });

  // Particles
  updateParticles(dt);drawParticles();
  updateSteam(dt);drawSteam();

  requestAnimationFrame(render);
}

requestAnimationFrame(render);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIVE DATA ‚Äî Fetch from /api/status.json
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function liveSetBadge(state, text) {
  const badge = document.getElementById('live-badge');
  const label = document.getElementById('live-text');
  if (badge) badge.className = state;
  if (label) label.textContent = text || state.toUpperCase();
}

function liveSetLastUpdated() {
  const el = document.getElementById('last-updated');
  if (el) {
    const d = new Date();
    el.textContent = 'Updated: ' + d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  }
}

async function fetchLiveData() {
  try {
    liveSetBadge('connecting', 'FETCHING...');
    const resp = await fetch(STATUS_URL + '?t=' + Date.now());
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    liveData = await resp.json();
    liveLastFetch = Date.now();

    // Update banner status dots
    if (liveData.channels) {
      updateDot('dot-gateway', liveData.gateway?.status || 'online');
      updateDot('dot-whatsapp', liveData.channels?.whatsapp || 'online');
      updateDot('dot-slack', liveData.channels?.slack || 'online');
      updateDot('dot-telegram', liveData.channels?.telegram || 'idle');
      updateDot('dot-memory', 'online');
      updateDot('dot-crons', 'online');
    }

    // Update ticker
    updateTicker(liveData);

    liveSetBadge('connected', 'LIVE');
    liveSetLastUpdated();
  } catch (e) {
    console.warn('[HQ] Status fetch error:', e);
    liveSetBadge('error', 'OFFLINE');

    // Use defaults on error
    if (!liveData) {
      liveData = {
        agents: { online: 22, total: 27 },
        sessions: { active: 14 },
        crons: { active: 21 },
        memory: { docs: 20241, knowledgeGraphNodes: 3847 },
        gateway: { uptime: '20d 14h' },
        katman: { launchDate: '2026-02-17', readinessPercent: 85 },
        meeting: { active: true, topic: 'Katman Launch Sprint', participants: ['Mahmut','Ziggy','katman-seo','katman-social'] }
      };
      updateTicker(liveData);
    }
  }
}

function updateDot(id, status) {
  const dot = document.getElementById(id);
  if (!dot) return;
  dot.className = 'dot ' + (status === 'online' ? 'on' : (status === 'idle' ? 'warn' : 'off'));
}

function updateTicker(data) {
  const tickerInner = document.getElementById('ticker-inner');
  if (!tickerInner || !data) return;

  const ag = data.agents || {};
  const sess = data.sessions || {};
  const cr = data.crons || {};
  const mem = data.memory || {};
  const gw = data.gateway || {};
  const kat = data.katman || {};

  // Katman countdown
  let countdownStr = '';
  if (kat.launchDate) {
    const launchDate = new Date(kat.launchDate + 'T00:00:00+03:00');
    const now = new Date();
    const diff = launchDate - now;
    if (diff > 0) {
      const days = Math.floor(diff / 86400000);
      const hours = Math.floor((diff % 86400000) / 3600000);
      countdownStr = `Katman Launch: ${days}d ${hours}h`;
    } else {
      countdownStr = 'üöÄ KATMAN LAUNCHED!';
    }
  }

  const allNominal = (ag.online || 0) >= (ag.total || 1) - 3;

  const items = [
    { cls: allNominal ? 'nominal' : 'warning-text', text: allNominal ? 'ALL SYSTEMS NOMINAL' : '‚ö† SYSTEMS DEGRADED' },
    { text: `Agents: ${ag.online||'?'}/${ag.total||'?'} online` },
    { text: `Sessions: ${sess.active||'?'} active` },
    { text: `Departments: 9` },
    { text: `Uptime: ${gw.uptime||'‚Äî'}` },
    { text: `Memory: ${(mem.docs||0).toLocaleString()} docs` },
    { text: `KG: ${(mem.knowledgeGraphNodes||0).toLocaleString()} nodes` },
    { text: `Crons: ${cr.active||'?'} active` },
    { text: countdownStr || 'Katman: Loading...' },
    { text: `${'‚ñà'.repeat(Math.floor((kat.readinessPercent||0)/10))}${'‚ñë'.repeat(10-Math.floor((kat.readinessPercent||0)/10))} ${kat.readinessPercent||0}% Launch Ready` },
  ];

  const buildSpans = () => items.map((item, i) => {
    const sep = i > 0 ? '<span class="sep">|</span>' : '';
    const cls = item.cls ? ` class="${item.cls}"` : '';
    return `${sep}<span${cls}>${item.text}</span>`;
  }).join('');

  tickerInner.innerHTML = buildSpans() + '<span class="sep">|</span>' + buildSpans();
}

// ‚îÄ‚îÄ‚îÄ ALSO TRY WEBSOCKET TO LOCAL GATEWAY (when viewed locally) ‚îÄ‚îÄ‚îÄ
const GATEWAY_WS_URL = 'ws://localhost:18789';
const GATEWAY_TOKEN = '41abe79a3a92d91413aebf177b79bc181f6ad03f1a784ea0';
let liveWs = null;
let liveReqId = 0;
let livePendingCallbacks = {};
let wsConnected = false;

function tryWebSocket() {
  // Only attempt WS if on localhost
  if (location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') return;
  
  try {
    liveWs = new WebSocket(GATEWAY_WS_URL);
  } catch(e) { return; }

  liveWs.onopen = () => {
    setTimeout(() => {
      wsRequest('connect', {
        minProtocol: 3, maxProtocol: 3,
        client: { id: 'hq-dashboard', version: 'v5', platform: 'web', mode: 'ui', instanceId: 'hq-' + Date.now() },
        role: 'operator', scopes: ['operator.admin'],
        auth: { token: GATEWAY_TOKEN }, caps: []
      }).then(() => {
        wsConnected = true;
        liveSetBadge('connected', 'LIVE WS');
        wsFetchAndUpdate();
        setInterval(wsFetchAndUpdate, LIVE_POLL_INTERVAL);
      }).catch(() => {
        liveSetBadge('error', 'AUTH FAIL');
      });
    }, 500);
  };

  liveWs.onmessage = (evt) => {
    let msg;
    try { msg = JSON.parse(evt.data); } catch { return; }
    if (msg.type === 'res') {
      const cb = livePendingCallbacks[msg.id];
      if (cb) {
        delete livePendingCallbacks[msg.id];
        if (msg.ok) cb.resolve(msg.payload);
        else cb.reject(msg.error);
      }
    }
  };

  liveWs.onclose = () => { wsConnected = false; };
  liveWs.onerror = () => {};
}

function wsRequest(method, params) {
  return new Promise((resolve, reject) => {
    if (!liveWs || liveWs.readyState !== WebSocket.OPEN) return reject('not connected');
    const id = String(++liveReqId);
    livePendingCallbacks[id] = { resolve, reject };
    liveWs.send(JSON.stringify({ type: 'req', id, method, params }));
    setTimeout(() => { if(livePendingCallbacks[id]){delete livePendingCallbacks[id];reject('timeout');} }, 10000);
  });
}

async function wsFetchAndUpdate() {
  if (!wsConnected) return;
  try {
    const sessResult = await wsRequest('sessions.list', { includeGlobal: true, includeUnknown: true });
    let healthResult = null;
    try { healthResult = await wsRequest('health', {}); } catch(e) {}
    let cronResult = null;
    try { cronResult = await wsRequest('cron.status', {}); } catch(e) {}

    const sessions = sessResult?.sessions || [];
    const now = Date.now();
    let onlineCount = 0;

    // Simple count
    const agentSeen = new Set();
    for (const sess of sessions) {
      const aid = sess.agentId || 'main';
      if (!agentSeen.has(aid)) {
        agentSeen.add(aid);
        const elapsed = now - (sess.updatedAt || sess.createdAt || 0);
        if (elapsed < 300000) onlineCount++;
      }
    }

    // Build live data from WS
    let uptimeStr = '‚Äî';
    if (healthResult?.uptimeMs) {
      const ms = healthResult.uptimeMs;
      const days = Math.floor(ms/86400000);
      const hours = Math.floor((ms%86400000)/3600000);
      uptimeStr = days>0?`${days}d ${hours}h`:`${hours}h`;
    }

    liveData = {
      agents: { online: onlineCount, total: AGENTS.length, idle: 0, offline: AGENTS.length - onlineCount },
      sessions: { active: sessions.filter(s=>s.active).length, total: sessions.length },
      crons: { active: cronResult?.enabled || 21 },
      memory: { docs: 20241, knowledgeGraphNodes: 3847 },
      gateway: { status: 'online', uptime: uptimeStr },
      channels: { whatsapp: 'online', telegram: 'idle', slack: 'online' },
      katman: { launchDate: '2026-02-17', readinessPercent: 85 },
      meeting: liveData?.meeting || { active: true, topic: 'Katman Launch Sprint', participants: ['Mahmut','Ziggy','katman-seo','katman-social'] }
    };

    updateTicker(liveData);
    liveSetLastUpdated();
    liveSetBadge('connected', 'LIVE WS');
  } catch(e) {
    console.warn('[HQ WS] Fetch error:', e);
  }
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
setTimeout(() => {
  fetchLiveData(); // Always fetch static JSON first
  setInterval(fetchLiveData, LIVE_POLL_INTERVAL);
  tryWebSocket(); // Try WS if local
}, 500);

</script>
</body>
</html>